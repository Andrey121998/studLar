
name: Deploy to Production

on:
push:
  branches: [ main ]
workflow_dispatch:  # Allows manual triggering

jobs:
test:
  name: Run Tests Before Deploy
  runs-on: ubuntu-latest

  services:
    mysql:
      image: mysql:8.0
      env:
        MYSQL_ROOT_PASSWORD: root
        MYSQL_DATABASE: laravel_test
      ports:
        - 3306:3306
      options: >-
        --health-cmd='mysqladmin ping'
        --health-interval=10s
        --health-timeout=5s
        --health-retries=3

  steps:
  - name: Checkout code
    uses: actions/checkout@v4

  - name: Setup PHP
    uses: shivammathur/setup-php@v2
    with:
      php-version: '8.3'
      extensions: mbstring, pdo, pdo_mysql, bcmath, ctype, fileinfo, json, openssl, tokenizer, xml, gd

  - name: Copy environment file
    run: |
      cp .env.example .env.testing
      echo 'APP_ENV=testing' >> .env.testing
      echo 'DB_CONNECTION=mysql' >> .env.testing
      echo 'DB_HOST=127.0.0.1' >> .env.testing
      echo 'DB_PORT=3306' >> .env.testing
      echo 'DB_DATABASE=laravel_test' >> .env.testing
      echo 'DB_USERNAME=root' >> .env.testing
      echo 'DB_PASSWORD=root' >> .env.testing

  - name: Install dependencies
    run: composer install --no-progress --prefer-dist --optimize-autoloader

  - name: Generate key
    run: php artisan key:generate --env=testing

  - name: Create database
    run: |
      mysql -h 127.0.0.1 -u root -proot -e 'CREATE DATABASE IF NOT EXISTS laravel_test;'

  - name: Run migrations
    run: php artisan migrate --env=testing --force

  - name: Run tests
    run: vendor/bin/phpunit --verbose

# SSH Deployment
deploy-ssh:
  name: Deploy via SSH
  runs-on: ubuntu-latest
  needs: test  # Only deploy if tests pass
  if: github.ref == 'refs/heads/main'

  steps:
  - name: Checkout code
    uses: actions/checkout@v4

  - name: Setup SSH key
    run: |
      mkdir -p ~/.ssh
      echo '${{ secrets.SSH_PRIVATE_KEY }}' > ~/.ssh/id_rsa
      chmod 600 ~/.ssh/id_rsa
      ssh-keyscan '${{ secrets.SSH_HOST }}' >> ~/.ssh/known_hosts

  - name: Deploy via SSH
    run: |
      ssh '${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}' '
        echo "Starting deployment..."
        cd /var/www/your-project

        # Pull latest changes
        git pull origin main

        # Install dependencies
        composer install --no-dev --no-progress --prefer-dist --optimize-autoloader

        # Run migrations
        php artisan migrate --force

        # Clear caches
        php artisan config:cache
        php artisan route:cache
        php artisan view:cache

        # Set permissions
        sudo chown -R www-data:www-data /var/www/your-project
        sudo chmod -R 755 storage
        sudo chmod -R 755 bootstrap/cache

        echo "Deployment completed successfully!"
      '

  - name: Deployment Notification
    run: echo 'ðŸš€ Application deployed successfully!'

# FTP Deployment (alternative)
deploy-ftp:
  name: Deploy via FTP
  runs-on: ubuntu-latest
  needs: test
  if: github.ref == 'refs/heads/main' && false  # Disabled by default

  steps:
  - name: Checkout code
    uses: actions/checkout@v4

  - name: FTP Deploy
    uses: SamKirkland/FTP-Deploy-Action@v4.3.4
    with:
      server: ${{ secrets.FTP_SERVER }}
      username: ${{ secrets.FTP_USERNAME }}
      password: ${{ secrets.FTP_PASSWORD }}
      server-dir: /public_html/
      local-dir: ./
      exclude: |
        **/.git*
        **/.github*
        **/node_modules/*
        **/tests/*
        **/.env*
        **/storage/logs/*
        **/*.md
