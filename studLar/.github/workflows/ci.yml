name: Laravel CI

on:
push:
  branches: [ main ]
pull_request:
  branches: [ main ]

jobs:
test:
  runs-on: ubuntu-latest

  services:
    mysql:
      image: mysql:8.0
      env:
        MYSQL_ROOT_PASSWORD: password
        MYSQL_DATABASE: laravel_test
      ports:
        - 3306:3306
      options: --health-cmd="mysqladmin ping --silent" --health-interval=10s --health-timeout=5s --health-retries=3

  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, pdo, pdo_mysql, bcmath, ctype, fileinfo, json, openssl, tokenizer, xml, gd
        coverage: none

    - name: Copy .env
      run: |
        cp .env.example .env || true
        echo "APP_ENV=testing" >> .env
        echo "DB_CONNECTION=mysql" >> .env
        echo "DB_HOST=127.0.0.1" >> .env
        echo "DB_PORT=3306" >> .env
        echo "DB_DATABASE=laravel_test" >> .env
        echo "DB_USERNAME=root" >> .env
        echo "DB_PASSWORD=password" >> .env

    - name: Install dependencies
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Generate key
      run: php artisan key:generate

    - name: Wait for MySQL
      run: |
        sudo apt-get update -y
        sudo apt-get install -y netcat
        for i in {1..60}; do
          nc -z 127.0.0.1 3306 && echo "MySQL is up" && break
          sleep 1
        done

    - name: Create database
      run: mysql -h 127.0.0.1 -u root -ppassword -e "CREATE DATABASE IF NOT EXISTS laravel_test;"

    - name: Run migrations
      run: php artisan migrate --force

    - name: Run tests
      run: vendor/bin/phpunit
